<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Analysis Dashboard</title>
    <style>
        /* --- Global Styles & Dark Theme --- */
        :root {
            --bg-color: #1a1a1d; /* Dark background */
            --card-bg-color: #2c2c31; /* Slightly lighter card background */
            --text-color: #e1e1e1; /* Light text */
            --text-muted-color: #aaaaaa; /* Dimmer text */
            --primary-color: #4caf50; /* Green accent */
            --primary-hover-color: #66bb6a;
            --error-color: #f44336; /* Red for errors/pwned */
            --success-color: #4caf50; /* Green for success/not pwned */
            --border-color: #444444;
            --input-bg-color: #333338;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            --border-radius: 6px;
            --box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px; /* Base font size */
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 2rem;
            text-align: center;
        }

        main {
            width: 100%;
            max-width: 900px; /* Max width for content */
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Space between sections */
        }

        /* --- Card/Section Styling --- */
        section {
            background-color: var(--card-bg-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        section h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        /* --- Form Elements --- */
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-muted-color);
        }

        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
        }

        textarea {
            resize: vertical; /* Allow vertical resize */
            min-height: 80px;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }

        button {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
            margin-right: 0.5rem; /* Space between buttons if needed */
        }

        button:hover:not(:disabled) {
            background-color: var(--primary-hover-color);
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- Result & Status Display --- */
        .result-area {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--input-bg-color); /* Slightly different bg for results */
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            min-height: 50px; /* Ensure it has some height even when empty */
        }

        .result-area h3 {
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }

        .result-area p {
            margin-bottom: 0.5rem;
        }
        .result-area ul {
           list-style-position: inside;
           margin-left: 0.5rem;
           margin-bottom: 0.5rem;
        }
         .result-area li {
           margin-bottom: 0.25rem;
         }

        .status-pwned {
            color: var(--error-color);
            font-weight: bold;
        }

        .status-not-pwned {
            color: var(--success-color);
            font-weight: bold;
        }

        /* --- Loader Animation --- */
        .loader {
            display: none; /* Hidden by default */
            border: 4px solid #f3f3f330; /* Light grey */
            border-top: 4px solid var(--primary-color); /* Accent */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto 0 auto; /* Center loader below button */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Error Display --- */
        #error-display {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: rgba(244, 67, 54, 0.2); /* Light red background */
            color: var(--error-color);
            border: 1px solid var(--error-color);
            border-radius: var(--border-radius);
            display: none; /* Hidden by default */
            width: 100%;
            max-width: 900px;
            text-align: center;
            font-weight: bold;
        }

         /* --- Smelter Image Display --- */
         #smelter-result-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive grid */
            gap: 1rem;
            margin-top: 1rem;
         }

         .smelter-image-container {
            background-color: var(--card-bg-color); /* Match card bg */
            padding: 0.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
         }
         .smelter-image-container img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0.5rem auto 0 auto; /* Space below title */
            background-color: #fff; /* White background for PNG transparency */
            border-radius: var(--border-radius);
         }
         .smelter-image-container p {
             font-weight: bold;
             color: var(--text-muted-color);
             margin-bottom: 0.2rem;
             text-transform: capitalize;
         }

    </style>
</head>
<body>

    <h1>Password Analysis Dashboard</h1>

    <div id="error-display"></div>

    <main>
        <!-- HIBP Checker Section -->
        <section id="hibp-section">
            <h2>HIBP Check (Offline)</h2>
            <label for="hibp-password">Password:</label>
            <input type="password" id="hibp-password" placeholder="Enter password to check">
            <button id="check-hibp-btn">Check HIBP</button>
            <div class="loader" id="hibp-loader"></div>
            <div class="result-area" id="hibp-result">
                <!-- HIBP result will appear here -->
            </div>
        </section>

        <!-- Ollama Analyzer Section -->
        <section id="ollama-section">
            <h2>Ollama Password Analysis</h2>
            <label for="ollama-password">Password:</label>
            <input type="password" id="ollama-password" placeholder="Enter password to analyze">
            <button id="analyze-ollama-btn">Analyze with Ollama</button>
            <div class="loader" id="ollama-loader"></div>
            <div class="result-area" id="ollama-result">
                <!-- Ollama analysis result will appear here -->
            </div>
        </section>

        <!-- Password Smelter Section -->
        <section id="smelter-section">
            <h2>Password Smelter Analysis</h2>
            <label for="smelter-passwords">Passwords (one per line):</label>
            <textarea id="smelter-passwords" rows="6" placeholder="Enter passwords, one per line..."></textarea>
            <button id="analyze-smelter-btn">Analyze with Smelter</button>
            <div class="loader" id="smelter-loader"></div>
            <div class="result-area" id="smelter-result">
                 <p id="smelter-message" style="text-align: center; color: var(--text-muted-color);"></p>
                 <div id="smelter-result-images">
                    <!-- Smelter analysis images will appear here -->
                 </div>
            </div>
        </section>
    </main>

    <script>
        const API_BASE_URL = "http://localhost:8000"; // ADJUST IF YOUR BACKEND IS ELSEWHERE

        // --- DOM Element References ---
        const hibpInput = document.getElementById('hibp-password');
        const hibpButton = document.getElementById('check-hibp-btn');
        const hibpLoader = document.getElementById('hibp-loader');
        const hibpResultDiv = document.getElementById('hibp-result');

        const ollamaInput = document.getElementById('ollama-password');
        const ollamaButton = document.getElementById('analyze-ollama-btn');
        const ollamaLoader = document.getElementById('ollama-loader');
        const ollamaResultDiv = document.getElementById('ollama-result');

        const smelterInput = document.getElementById('smelter-passwords');
        const smelterButton = document.getElementById('analyze-smelter-btn');
        const smelterLoader = document.getElementById('smelter-loader');
        const smelterResultDiv = document.getElementById('smelter-result');
        const smelterResultMessage = document.getElementById('smelter-message');
        const smelterImagesDiv = document.getElementById('smelter-result-images');

        const errorDisplay = document.getElementById('error-display');

        // --- Helper Functions ---
        function showLoader(loaderElement) {
            loaderElement.style.display = 'block';
        }

        function hideLoader(loaderElement) {
            loaderElement.style.display = 'none';
        }

        function disableButton(buttonElement) {
            buttonElement.disabled = true;
        }

        function enableButton(buttonElement) {
            buttonElement.disabled = false;
        }

        function displayError(message) {
            errorDisplay.textContent = `Error: ${message}`;
            errorDisplay.style.display = 'block';
            // Hide error after some time
             setTimeout(() => {
                 errorDisplay.style.display = 'none';
             }, 6000);
        }

        function clearError() {
            errorDisplay.style.display = 'none';
            errorDisplay.textContent = '';
        }

        function clearResults(...resultDivs) {
             resultDivs.forEach(div => {
                 if(div) div.innerHTML = '';
             });
             // Special clearing for smelter
             if (smelterResultMessage) smelterResultMessage.textContent = '';
             if (smelterImagesDiv) smelterImagesDiv.innerHTML = '';
        }

        // --- API Call Functions ---

        async function checkHibp() {
            const password = hibpInput.value;
            if (!password) {
                displayError("Please enter a password for HIBP check.");
                return;
            }

            clearError();
            clearResults(hibpResultDiv);
            showLoader(hibpLoader);
            disableButton(hibpButton);

            try {
                const encodedPassword = encodeURIComponent(password);
                const response = await fetch(`${API_BASE_URL}/hibp/check-password/?password=${encodedPassword}`);

                if (!response.ok) {
                    let errorMsg = `HIBP check failed (Status: ${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorMsg += `: ${errorData.detail || response.statusText}`;
                    } catch (e) { /* Ignore if error body isn't JSON */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                displayHibpResult(data);

            } catch (error) {
                console.error("HIBP Check Error:", error);
                displayError(error.message || "Could not connect to HIBP service.");
            } finally {
                hideLoader(hibpLoader);
                enableButton(hibpButton);
            }
        }

        async function analyzeOllama() {
            const password = ollamaInput.value;
            if (!password) {
                displayError("Please enter a password for Ollama analysis.");
                return;
            }

            clearError();
            clearResults(ollamaResultDiv);
            showLoader(ollamaLoader);
            disableButton(ollamaButton);

            // Construct the prompt (adjust if your backend expects a different structure)
            // This matches the Ollama router example which expects a specific prompt format
             const prompt = `Analyze the strength of the password "${password}". Provide: 1. Suggestions for improvement (as a list). 2. Reasoning for the analysis (as a list, max 2 items). 3. An improved 16-character password suggestion. Format the output strictly as JSON: {"suggestions": ["suggestion1", ...], "reasoning": ["reasoning1", ...], "improvedPassword": "new_password"}`;

            const requestBody = {
                contents: [{ parts: [{ text: prompt }] }],
                // generation_config can be added here if needed by your backend
            };

            try {
                const response = await fetch(`${API_BASE_URL}/ollama/generateContent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                 if (!response.ok) {
                    let errorMsg = `Ollama analysis failed (Status: ${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorMsg += `: ${errorData.detail || response.statusText}`;
                    } catch (e) { /* Ignore if error body isn't JSON */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                displayOllamaResult(data);

            } catch (error) {
                console.error("Ollama Analysis Error:", error);
                displayError(error.message || "Could not connect to Ollama service.");
                 ollamaResultDiv.innerHTML = `<p style="color: var(--error-color);">Analysis failed. Check console for details.</p>`;
            } finally {
                hideLoader(ollamaLoader);
                enableButton(ollamaButton);
            }
        }

        async function analyzeSmelter() {
            const passwordsText = smelterInput.value;
            if (!passwordsText.trim()) {
                displayError("Please enter at least one password for Smelter analysis.");
                return;
            }

            // Split by newline, trim whitespace, and filter out empty lines
            const passwords = passwordsText.split('\n')
                                         .map(p => p.trim())
                                         .filter(p => p.length > 0);

             if (passwords.length === 0) {
                displayError("Please enter valid passwords (one per line).");
                return;
            }

            clearError();
            clearResults(smelterResultDiv, smelterResultMessage, smelterImagesDiv);
            showLoader(smelterLoader);
            disableButton(smelterButton);

            const requestBody = { passwords: passwords };

            try {
                 const response = await fetch(`${API_BASE_URL}/smelter/analyze/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                 if (!response.ok) {
                    let errorMsg = `Smelter analysis failed (Status: ${response.status})`;
                    try {
                        const errorData = await response.json();
                        errorMsg += `: ${errorData.detail || response.statusText}`;
                    } catch (e) { /* Ignore if error body isn't JSON */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                displaySmelterResult(data);

            } catch (error) {
                console.error("Smelter Analysis Error:", error);
                displayError(error.message || "Could not connect to Smelter service.");
                smelterResultMessage.textContent = 'Analysis failed.';
                smelterResultMessage.style.color = 'var(--error-color)';
            } finally {
                hideLoader(smelterLoader);
                enableButton(smelterButton);
            }
        }


        // --- Display Functions ---

        function displayHibpResult(data) {
            hibpResultDiv.innerHTML = ''; // Clear previous
            const resultP = document.createElement('p');
            if (data.pwned) {
                resultP.textContent = 'Status: Pwned! This password was found in data breaches.';
                resultP.className = 'status-pwned';
            } else {
                resultP.textContent = 'Status: Not found in known data breaches.';
                resultP.className = 'status-not-pwned';
            }
            hibpResultDiv.appendChild(resultP);

            const methodP = document.createElement('p');
            methodP.textContent = `Checked using: ${data.check_method || 'offline database'}`;
            methodP.style.fontSize = '0.9em';
            methodP.style.color = 'var(--text-muted-color)';
            hibpResultDiv.appendChild(methodP);
        }

        function displayOllamaResult(data) {
            ollamaResultDiv.innerHTML = ''; // Clear previous

            if (data.reasoning && data.reasoning.length > 0) {
                const reasoningH3 = document.createElement('h3');
                reasoningH3.textContent = 'Reasoning:';
                ollamaResultDiv.appendChild(reasoningH3);
                const reasoningUl = document.createElement('ul');
                data.reasoning.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    reasoningUl.appendChild(li);
                });
                 ollamaResultDiv.appendChild(reasoningUl);
            } else {
                 ollamaResultDiv.innerHTML += `<p><em>No reasoning provided by the model.</em></p>`;
            }


            if (data.suggestions && data.suggestions.length > 0) {
                 const suggestionsH3 = document.createElement('h3');
                 suggestionsH3.textContent = 'Suggestions:';
                 ollamaResultDiv.appendChild(suggestionsH3);
                 const suggestionsUl = document.createElement('ul');
                 data.suggestions.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    suggestionsUl.appendChild(li);
                });
                 ollamaResultDiv.appendChild(suggestionsUl);
            } else {
                 ollamaResultDiv.innerHTML += `<p><em>No suggestions provided by the model.</em></p>`;
            }


            if (data.improvedPassword) {
                 const improvedH3 = document.createElement('h3');
                 improvedH3.textContent = 'Improved Password Suggestion:';
                 ollamaResultDiv.appendChild(improvedH3);
                 const improvedP = document.createElement('p');
                 improvedP.textContent = data.improvedPassword;
                 improvedP.style.fontFamily = 'monospace'; // Use monospace for passwords
                 improvedP.style.fontWeight = 'bold';
                 improvedP.style.backgroundColor = 'var(--bg-color)';
                 improvedP.style.padding = '0.3rem 0.6rem';
                 improvedP.style.borderRadius = '4px';
                 improvedP.style.display = 'inline-block';
                 ollamaResultDiv.appendChild(improvedP);
            } else {
                 ollamaResultDiv.innerHTML += `<p><em>No improved password provided by the model.</em></p>`;
            }
        }

         function displaySmelterResult(data) {
            smelterResultMessage.textContent = data.message || "Analysis complete.";
            smelterResultMessage.style.color = data.images ? 'var(--text-muted-color)' : 'var(--error-color)'; // Use error color if no images
            smelterImagesDiv.innerHTML = ''; // Clear previous images

            if (data.images && Object.keys(data.images).length > 0) {
                for (const [key, base64Image] of Object.entries(data.images)) {
                    const container = document.createElement('div');
                    container.className = 'smelter-image-container';

                    const title = document.createElement('p');
                    title.textContent = key.replace(/([A-Z])/g, ' $1').trim(); // Add space before caps for readability

                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${base64Image}`;
                    img.alt = `Password Analysis Chart: ${key}`;
                    img.loading = 'lazy'; // Lazy load images

                    container.appendChild(title);
                    container.appendChild(img);
                    smelterImagesDiv.appendChild(container);
                }
            } else {
                 smelterResultMessage.textContent = "Analysis ran, but no images were returned.";
                 smelterResultMessage.style.color = 'var(--error-color)';
            }

             // Optionally display stderr output if present
             if(data.stderr_output) {
                 const stderrP = document.createElement('p');
                 stderrP.textContent = `Analysis Tool Output: ${data.stderr_output}`;
                 stderrP.style.fontSize = '0.8em';
                 stderrP.style.color = 'var(--text-muted-color)';
                 stderrP.style.marginTop = '1rem';
                 stderrP.style.fontFamily = 'monospace';
                 smelterResultDiv.insertBefore(stderrP, smelterImagesDiv); // Add before images
             }
        }


        // --- Event Listeners ---
        hibpButton.addEventListener('click', checkHibp);
        // Allow pressing Enter in HIBP input field
        hibpInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                checkHibp();
            }
        });


        ollamaButton.addEventListener('click', analyzeOllama);
         // Allow pressing Enter in Ollama input field
        ollamaInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                analyzeOllama();
            }
        });

        smelterButton.addEventListener('click', analyzeSmelter);

    </script>

</body>
</html>